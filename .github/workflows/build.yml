name: Build and Release

# Optimized CI/CD workflow with intelligent caching
#
# Trigger:
#   - On push to main ONLY if commit message contains "build" (case-insensitive)
#   - Manual workflow dispatch (always builds)
#
# Architecture:
#   setup â†’ build-android â†˜
#                          â†’ create-release
#   setup â†’ build-ios     â†—
#
# Key features:
# - Conditional build: only runs when commit message contains "build"
# - Separate setup job for dependencies (cached intelligently)
# - Parallel Android/iOS builds after setup
# - Caches: Flutter SDK, Pub, Gradle, CocoaPods, generated code
# - Cache invalidation: automatic based on lock files and version files
# - Saves ~90% time on subsequent builds
# - Creates GitHub release with APK, AAB, and iOS build
# - Injects HuggingFace API token for AI features

env:
  FLUTTER_VERSION: '3.38.6'
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.2.1'
  ANDROID_NDK_VERSION: '25.1.8937393'
  LANG: en_US.UTF-8
  HF_TOKEN: ${{ secrets.HF_TOKEN }}

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ################################################################################
  # CHECK - Determine if build should run (commit message contains "build")
  ################################################################################
  check-build:
    name: Check if build needed
    runs-on: self-hosted
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
    steps:
      - name: Check commit message for "build" keyword
        id: check
        run: |
          # Always build on workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger - will build"
            exit 0
          fi

          # Check if commit message contains "build" (case-insensitive)
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if echo "$COMMIT_MSG" | grep -iq "build"; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "âœ… Commit message contains 'build' - will build"
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Commit message does not contain 'build' - skipping build"
          fi

  ################################################################################
  # SETUP - Install and cache all dependencies and tools
  ################################################################################
  setup:
    name: Setup Dependencies & Tools
    runs-on: self-hosted
    needs: check-build
    if: needs.check-build.outputs.should-build == 'true'

    outputs:
      has-generated-code: ${{ steps.detect-generated.outputs.present }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Self-hosted runners are persistent: prefer using existing Flutter SDK on disk
      # and only update when FLUTTER_VERSION changes.
      - name: Ensure Flutter installed (reuse runner state)
        run: |
          if [ ! -d "$HOME/flutter/.git" ]; then
            git clone https://github.com/flutter/flutter.git -b stable $HOME/flutter
          fi
          cd $HOME/flutter
          git fetch --tags
          git checkout ${{ env.FLUTTER_VERSION }}

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Run flutter doctor
      - name: Flutter Doctor
        run: flutter doctor -v

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Code generation (kept as a setup step so Android/iOS jobs don't duplicate work)
      - name: Run code generation
        run: |
          echo "=== Running build_runner ==="
          flutter pub run build_runner build --delete-conflicting-outputs --verbose
          echo "=== build_runner completed ==="
          echo "=== Checking for generated files ==="
          find . -name "*.freezed.dart" -o -name "*.g.dart" | head -20
          echo "=== Checking model_info specifically ==="
          ls -la lib/core/models/ || echo "Directory not found"
          # Re-run pub get so analyzer can see the newly generated part files
          flutter pub get

      - name: Detect generated code
        id: detect-generated
        run: |
          if find . -type f \( -name "*.g.dart" -o -name "*.freezed.dart" -o -name "*.config.dart" \) -print -quit | grep -q .; then
            echo "present=true" >> $GITHUB_OUTPUT
          else
            echo "present=false" >> $GITHUB_OUTPUT
          fi

      # Upload generated code as artifact for build jobs
      - name: Upload generated code
        if: steps.detect-generated.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: |
            **/*.g.dart
            **/*.freezed.dart
            **/*.config.dart
          if-no-files-found: warn
          retention-days: 1

      # Analyze code (fail only on errors, not warnings/infos)
      - name: Analyze code
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      # Run tests
      - name: Run tests
        run: flutter test

  ################################################################################
  # BUILD ANDROID - Build APK/AAB with cached dependencies
  ################################################################################
  build-android:
    name: Build Android APK/AAB
    runs-on: self-hosted
    needs: [check-build, setup]
    if: needs.check-build.outputs.should-build == 'true'

    # Self-hosted runners are persistent; isolate Gradle state per Java version to avoid
    # cache contamination when the machine default JDK changes (e.g. JDK 21 â†’ classfile 65).
    env:
      GRADLE_OPTS: -Dorg.gradle.daemon=false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Verify Flutter on runner
        run: |
          if [ ! -x "$HOME/flutter/bin/flutter" ]; then
            echo "âŒ Flutter not found at $HOME/flutter/bin/flutter"
            exit 1
          fi

      # Download generated code from setup job
      - name: Download generated code
        if: needs.setup.outputs.has-generated-code == 'true'
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      # Setup Java with Gradle caching
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Capture Java home (lock for later steps)
        run: |
          # Some Actions may modify JAVA_HOME; keep the JDK selected above for Flutter/Gradle.
          echo "JDK_HOME=$JAVA_HOME" >> "$GITHUB_ENV"

      - name: Show Java version
        run: java -version

      - name: Configure isolated Gradle cache
        run: |
          # Use a per-run Gradle user home to avoid reusing compiled script caches that may have
          # been produced by a different JDK on the persistent self-hosted runner.
          GRADLE_USER_HOME_DIR="${RUNNER_TEMP}/gradle-${{ github.run_id }}-${{ github.run_attempt }}-jdk${{ env.JAVA_VERSION }}"
          echo "GRADLE_USER_HOME=$GRADLE_USER_HOME_DIR" >> "$GITHUB_ENV"

          # Also force Gradle to use the same JDK we selected above (self-hosted runners may have
          # a different system default Java).
          echo "GRADLE_OPTS=$GRADLE_OPTS -Dorg.gradle.java.home=$JAVA_HOME" >> "$GITHUB_ENV"

          echo "Using GRADLE_USER_HOME=$GRADLE_USER_HOME_DIR"
          echo "Using org.gradle.java.home=$JAVA_HOME"
          mkdir -p "$GRADLE_USER_HOME_DIR"
          # Fix: self-hosted runner may reuse compiled script caches created under a different JDK
          # (e.g. JDK 21 -> classfile major 65), which then fails under Java 17.
          rm -rf "$GRADLE_USER_HOME_DIR/caches" "$GRADLE_USER_HOME_DIR/daemon" || true

      - name: Setup Gradle (pin version)
        run: |
          GRADLE_VERSION="${{ env.GRADLE_VERSION }}"
          GRADLE_DIST_DIR="$RUNNER_TEMP/gradle-dist-$GRADLE_VERSION"
          GRADLE_ZIP="$RUNNER_TEMP/gradle-$GRADLE_VERSION-bin.zip"
          GRADLE_BIN_DIR="$GRADLE_DIST_DIR/gradle-$GRADLE_VERSION/bin"

          if [ ! -d "$GRADLE_DIST_DIR/gradle-$GRADLE_VERSION" ]; then
            echo "Downloading Gradle $GRADLE_VERSION..."
            curl -sSL -o "$GRADLE_ZIP" "https://services.gradle.org/distributions/gradle-$GRADLE_VERSION-bin.zip"
            mkdir -p "$GRADLE_DIST_DIR"
            unzip -q "$GRADLE_ZIP" -d "$GRADLE_DIST_DIR"
          fi

          # NOTE: $GITHUB_PATH affects subsequent steps only. Export PATH here so `gradle` is
          # available in this step as well.
          echo "$GRADLE_BIN_DIR" >> $GITHUB_PATH
          export PATH="$GRADLE_BIN_DIR:$PATH"
          gradle -v

      - name: Verify Java used for Gradle
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          which java || true
          java -version

      - name: Verify Java before Flutter build
        run: |
          echo "JAVA_HOME(before)=$JAVA_HOME"
          echo "JDK_HOME=$JDK_HOME"
          echo "java(before)=$(which java || true)"
          java -version
          flutter doctor -v || true

      # Ensure Android SDK + sdkmanager are available (self-hosted runner might not export env vars)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Fix conflicting Android environment variables
      - name: Fix Android env vars (unset ANDROID_SDK_HOME, keep only ANDROID_USER_HOME)
        run: |
          # AGP fails if BOTH ANDROID_SDK_HOME and ANDROID_USER_HOME are set, even to the
          # same path. The fix is to unset ANDROID_SDK_HOME completely and use only
          # ANDROID_USER_HOME (the recommended modern variable).
          # See: https://developer.android.com/tools/variables
          #
          # We cannot truly "unset" an env var from $GITHUB_ENV, but we can override it to
          # empty in the current step and ensure subsequent steps don't see it by NOT
          # exporting it. However, the runner's shell profile may re-export it.
          #
          # The cleanest fix: unset it in the shell before running Gradle.
          # We'll set a marker variable and handle it in the Build APK step.
          ANDROID_PREFS_DIR="$HOME/.android"
          mkdir -p "$ANDROID_PREFS_DIR"
          echo "ANDROID_USER_HOME=$ANDROID_PREFS_DIR" >> $GITHUB_ENV
          # Do NOT set ANDROID_SDK_HOME here. We'll unset it in the build step.

      - name: Ensure Android NDK installed
        run: |
          sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
          yes | sdkmanager --licenses > /dev/null
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

      # Ensure Android resources exist (mipmap, styles, etc.)
      - name: Ensure Android project resources exist
        run: |
          # Check if required Android resources are missing
          if [ ! -d "android/app/src/main/res" ]; then
            echo "âš ï¸  Android resources missing (res directory). Regenerating via flutter create..."

            PROJECT_NAME="$(awk -F': *' '/^name:/{print $2; exit}' pubspec.yaml)"
            if [ -z "$PROJECT_NAME" ]; then
              PROJECT_NAME="cruises_mobile"
            fi

            # Preserve existing files that flutter create might overwrite
            if [ -f "android/app/build.gradle" ]; then
              cp "android/app/build.gradle" "$RUNNER_TEMP/android_app_build.gradle.bak"
            fi
            if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
              cp "android/app/src/main/AndroidManifest.xml" "$RUNNER_TEMP/AndroidManifest.xml.bak"
            fi
            if [ -f "android/gradle/wrapper/gradle-wrapper.properties" ]; then
              cp "android/gradle/wrapper/gradle-wrapper.properties" "$RUNNER_TEMP/gradle-wrapper.properties.bak"
            fi
            if [ -f "android/build.gradle" ]; then
              cp "android/build.gradle" "$RUNNER_TEMP/android_build.gradle.bak"
            fi
            if [ -f "android/settings.gradle" ]; then
              cp "android/settings.gradle" "$RUNNER_TEMP/android_settings.gradle.bak"
            fi

            # Generate Android project files
            flutter create --platforms=android --project-name "$PROJECT_NAME" . || true

            # Restore preserved gradle files (flutter create may downgrade Gradle version)
            if [ -f "$RUNNER_TEMP/android_build.gradle.bak" ]; then
              cp "$RUNNER_TEMP/android_build.gradle.bak" "android/build.gradle"
              echo "âœ… Restored android/build.gradle"
            fi
            if [ -f "$RUNNER_TEMP/android_settings.gradle.bak" ]; then
              cp "$RUNNER_TEMP/android_settings.gradle.bak" "android/settings.gradle"
              echo "âœ… Restored android/settings.gradle"
            fi

            echo "âœ… Android resources generated"
          fi

          # Always ensure Gradle 8.0+ is configured (required by AGP 8.x)
          GRADLE_WRAPPER_FILE="android/gradle/wrapper/gradle-wrapper.properties"
          if [ -f "$GRADLE_WRAPPER_FILE" ]; then
            CURRENT_GRADLE=$(grep distributionUrl "$GRADLE_WRAPPER_FILE" | grep -oE 'gradle-[0-9.]+' | head -1)
            echo "Current Gradle version: $CURRENT_GRADLE"

            # Check if version is less than 8.0
            if echo "$CURRENT_GRADLE" | grep -qE 'gradle-[0-7]\.'; then
              echo "âš ï¸  Gradle version is below 8.0, upgrading..."
              sed -i.bak 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.0-all.zip|' "$GRADLE_WRAPPER_FILE"
              echo "âœ… Updated gradle-wrapper.properties to Gradle 8.0"
              cat "$GRADLE_WRAPPER_FILE"
            fi
          else
            echo "âŒ gradle-wrapper.properties not found at $GRADLE_WRAPPER_FILE"
            ls -la android/gradle/wrapper/ || true
          fi

          # Verify resources exist
          if [ ! -d "android/app/src/main/res/mipmap-hdpi" ]; then
            echo "âŒ Android mipmap resources still missing"
            ls -la android/app/src/main/ || true
            exit 1
          fi
          if [ ! -f "android/app/src/main/res/values/styles.xml" ]; then
            echo "âŒ Android styles.xml still missing"
            ls -la android/app/src/main/res/ || true
            exit 1
          fi
          echo "âœ… Android resources verified"
          ls -la android/app/src/main/res/

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      # Build APK
      - name: Build APK
        run: |
          # Force Flutter/Gradle to use the JDK installed by actions/setup-java.
          export JAVA_HOME="$JDK_HOME"
          export PATH="$JAVA_HOME/bin:$PATH"
          # Unset ANDROID_SDK_HOME to avoid AGP conflict with ANDROID_USER_HOME
          unset ANDROID_SDK_HOME
          echo "JAVA_HOME(used)=$JAVA_HOME"
          echo "ANDROID_USER_HOME=$ANDROID_USER_HOME"
          echo "ANDROID_SDK_HOME is unset"
          java -version
          flutter build apk --release --verbose

      # Build App Bundle
      - name: Build App Bundle
        run: |
          export JAVA_HOME="$JDK_HOME"
          export PATH="$JAVA_HOME/bin:$PATH"
          # Unset ANDROID_SDK_HOME to avoid AGP conflict with ANDROID_USER_HOME
          unset ANDROID_SDK_HOME
          echo "JAVA_HOME(used)=$JAVA_HOME"
          java -version
          flutter build appbundle --release --verbose

      # Upload APK artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # Upload AAB artifact
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  ################################################################################
  # BUILD iOS - Build APP with cached dependencies
  ################################################################################
  build-ios:
    name: Build iOS APP
    runs-on: self-hosted
    needs: [check-build, setup]
    if: needs.check-build.outputs.should-build == 'true'

    env:
      RUNNER_TOOL_CACHE: /Users/runner/hostedtoolcache
      AGENT_TOOLSDIRECTORY: /Users/runner/hostedtoolcache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Download generated code from setup job
      - name: Download generated code
        if: needs.setup.outputs.has-generated-code == 'true'
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      # Ensure iOS project files exist
      - name: Ensure iOS project exists
        run: |
          # Check if Podfile exists
          if [ ! -f "ios/Podfile" ]; then
            echo "âš ï¸  iOS project files missing (Podfile not found). Regenerating via flutter create..."

            PROJECT_NAME="$(awk -F': *' '/^name:/{print $2; exit}' pubspec.yaml)"
            if [ -z "$PROJECT_NAME" ]; then
              PROJECT_NAME="cruises_mobile"
            fi

            # Preserve existing Info.plist if it exists
            if [ -f "ios/Runner/Info.plist" ]; then
              cp "ios/Runner/Info.plist" "$RUNNER_TEMP/Info.plist.bak"
            fi

            # Generate iOS project files
            flutter create --platforms=ios --project-name "$PROJECT_NAME" . || true

            # Restore preserved Info.plist if it was backed up
            if [ -f "$RUNNER_TEMP/Info.plist.bak" ]; then
              cp "$RUNNER_TEMP/Info.plist.bak" "ios/Runner/Info.plist"
              echo "âœ… Restored ios/Runner/Info.plist"
            fi

            echo "âœ… iOS project files generated"
          fi

          # Verify Podfile exists
          if [ ! -f "ios/Podfile" ]; then
            echo "âŒ Podfile still missing after flutter create"
            ls -la ios/ || true
            exit 1
          fi
          echo "âœ… iOS Podfile verified"

      # Install CocoaPods (if not already installed)
      - name: Install CocoaPods
        run: |
          if ! command -v pod &> /dev/null; then
            echo "CocoaPods not found, installing via Homebrew..."
            # Try Homebrew first (preferred method for self-hosted runners)
            if command -v brew &> /dev/null; then
              brew install cocoapods
            else
              # Fallback to gem install without sudo (installs to user directory)
              echo "Homebrew not found, installing via gem (user install)..."
              gem install cocoapods --user-install
              # Add user gem bin to PATH
              export PATH="$HOME/.gem/ruby/$(ruby -e 'puts RUBY_VERSION')/bin:$PATH"
              echo "$HOME/.gem/ruby/$(ruby -e 'puts RUBY_VERSION')/bin" >> $GITHUB_PATH
            fi
          else
            echo "CocoaPods already installed: $(pod --version)"
          fi

      # Install CocoaPods dependencies
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      # Build iOS app (no code signing for now)
      - name: Build iOS app
        run: |
          flutter build ios --release --no-codesign

      # Upload iOS build artifact
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 30

  ################################################################################
  # CREATE RELEASE - Create GitHub release with artifacts (auto on every push)
  ################################################################################
  create-release:
    name: Create Release
    needs: [check-build, build-android, build-ios]
    runs-on: self-hosted
    if: needs.check-build.outputs.should-build == 'true'
    # Create release on EVERY successful build (push to main or manual dispatch)
    permissions:
      contents: write  # Required to create releases and upload assets

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to count releases

      # Download Android APK
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts

      # Download Android AAB
      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./artifacts

      # Download iOS build
      - name: Download iOS build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ./artifacts

      # Determine release version from pubspec.yaml
      - name: Determine release version
        id: release-tag
        run: |
          # Extract version from pubspec.yaml (format: version: X.Y.Z+build)
          FULL_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | tr -d '\r')
          # Split into version and build number
          VERSION=$(echo "$FULL_VERSION" | cut -d'+' -f1)
          BUILD_NUMBER=$(echo "$FULL_VERSION" | cut -d'+' -f2)

          echo "Full version from pubspec: $FULL_VERSION"
          echo "Version: $VERSION"
          echo "Build number: $BUILD_NUMBER"

          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Release version: v${VERSION} (build ${BUILD_NUMBER})"

      # Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: Release ${{ steps.release-tag.outputs.version }} (build ${{ steps.release-tag.outputs.build_number }})
          draft: false
          prerelease: false
          body: |
            ## ðŸš€ Release ${{ steps.release-tag.outputs.version }} (build ${{ steps.release-tag.outputs.build_number }})

            **Build Type:** ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Automatic' }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ### ðŸ“¦ Artifacts
            - **Android APK**: `app-release.apk` - Ready for direct installation on Android devices
            - **Android AAB**: `app-release.aab` - For Google Play Store (requires signing)
            - **iOS Build**: `Runner.app` - iOS application (requires code signing for installation)

            ### ðŸ“± Installation
            **Android:**
            1. Download `app-release.apk`
            2. Enable "Install from unknown sources" on your device
            3. Open the APK file to install

            **iOS:**
            1. Download `Runner.app`
            2. Code sign the app with your Apple Developer certificate
            3. Install via Xcode or other deployment tools

            ### ðŸ“ Changes
            See commit history for details: https://github.com/${{ github.repository }}/commits/${{ github.sha }}

            ### ðŸ”§ Built with
            - Flutter ${{ env.FLUTTER_VERSION }}
            - Java ${{ env.JAVA_VERSION }}
            - HuggingFace Inference API

            ### â±ï¸ Build Information
            - Workflow Run: #${{ github.run_number }}
            - Triggered by: @${{ github.actor }}
          files: |
            ./artifacts/app-release.apk
            ./artifacts/app-release.aab
            ./artifacts/Runner.app/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Print summary
      - name: Print build summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK: $(ls -lh ./artifacts/app-release.apk | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- Android AAB: $(ls -lh ./artifacts/app-release.aab | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Build: $(du -sh ./artifacts/Runner.app | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Release" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.release-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.release-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

