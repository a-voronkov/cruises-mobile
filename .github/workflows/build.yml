name: Build and Release

# Optimized CI/CD workflow with intelligent caching
#
# Trigger: Manual workflow dispatch only (via GitHub Actions UI)
#
# Architecture:
#   setup â†’ build-android â†˜
#                          â†’ create-release
#   setup â†’ build-ios     â†—
#
# Key features:
# - Manual trigger only - no automatic builds on push/PR
# - Separate setup job for dependencies (cached intelligently)
# - Parallel Android/iOS builds after setup
# - Caches: Flutter SDK, Pub, Gradle, CocoaPods, llama.cpp, generated code
# - Cache invalidation: automatic based on lock files and version files
# - Saves ~90% time on subsequent builds
# - Creates GitHub release with APK, AAB, and iOS build

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'
  LANG: en_US.UTF-8

on:
  workflow_dispatch:  # Only manual trigger via GitHub Actions UI

jobs:
  ################################################################################
  # SETUP - Install and cache all dependencies and tools
  ################################################################################
  setup:
    name: Setup Dependencies & Tools
    runs-on: self-hosted
    outputs:
      cache-hit-flutter: ${{ steps.cache-flutter.outputs.cache-hit }}
      cache-hit-pub: ${{ steps.cache-pub.outputs.cache-hit }}
      cache-hit-generated: ${{ steps.cache-generated.outputs.cache-hit }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Cache Flutter SDK
      - name: Cache Flutter SDK
        id: cache-flutter
        uses: actions/cache@v4
        with:
          path: ~/flutter
          key: flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}
          restore-keys: |
            flutter-${{ runner.os }}-

      # Install Flutter if not cached
      - name: Install Flutter
        if: steps.cache-flutter.outputs.cache-hit != 'true'
        run: |
          if [ ! -d "$HOME/flutter/bin" ]; then
            git clone https://github.com/flutter/flutter.git -b stable $HOME/flutter
          fi
          cd $HOME/flutter
          git checkout ${{ env.FLUTTER_VERSION }}

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Upgrade Flutter to ensure latest stable
      - name: Upgrade Flutter
        run: |
          flutter upgrade --force
          flutter --version

      # Run flutter doctor
      - name: Flutter Doctor
        run: flutter doctor -v

      # Cache Pub dependencies
      - name: Cache Pub dependencies
        id: cache-pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Cache generated code
      - name: Cache generated code
        id: cache-generated
        uses: actions/cache@v4
        with:
          path: |
            **/*.g.dart
            **/*.freezed.dart
            **/*.config.dart
          key: generated-${{ runner.os }}-${{ hashFiles('**/pubspec.lock', 'lib/**/*.dart') }}
          restore-keys: |
            generated-${{ runner.os }}-

      # Run code generation if not cached
      - name: Run code generation
        if: steps.cache-generated.outputs.cache-hit != 'true'
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # Upload generated code as artifact for build jobs
      - name: Upload generated code
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: |
            **/*.g.dart
            **/*.freezed.dart
            **/*.config.dart
          retention-days: 1

      # Analyze code
      - name: Analyze code
        run: flutter analyze

      # Run tests
      - name: Run tests
        run: flutter test

  ################################################################################
  # BUILD ANDROID - Build APK/AAB with cached dependencies
  ################################################################################
  build-android:
    name: Build Android APK/AAB
    runs-on: self-hosted
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Restore Flutter SDK from cache
      - name: Restore Flutter SDK
        uses: actions/cache/restore@v4
        with:
          path: ~/flutter
          key: flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}
          fail-on-cache-miss: true

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Restore Pub dependencies
      - name: Restore Pub dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          fail-on-cache-miss: true

      # Download generated code from setup job
      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      # Setup Java with Gradle caching
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # Cache Gradle dependencies
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # Cache llama.cpp Android libraries
      - name: Cache llama.cpp Android libraries
        id: cache-llama-android
        uses: actions/cache@v4
        with:
          path: android/app/src/main/jniLibs
          key: llama-android-${{ hashFiles('scripts/llama-version.txt') }}
          restore-keys: |
            llama-android-

      # Build llama.cpp for Android if not cached
      - name: Build llama.cpp for Android
        if: steps.cache-llama-android.outputs.cache-hit != 'true'
        run: |
          chmod +x scripts/build-llama-android.sh
          bash scripts/build-llama-android.sh
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # Verify llama.cpp library exists
      - name: Verify llama.cpp library
        run: |
          if [ ! -f "android/app/src/main/jniLibs/arm64-v8a/libllama.so" ]; then
            echo "âŒ Error: libllama.so not found!"
            exit 1
          fi
          echo "âœ… llama.cpp library found"
          ls -lh android/app/src/main/jniLibs/*/libllama.so

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      # Build APK
      - name: Build APK
        run: flutter build apk --release

      # Build App Bundle
      - name: Build App Bundle
        run: flutter build appbundle --release

      # Upload APK artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # Upload AAB artifact
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  ################################################################################
  # BUILD iOS - Build IPA with cached dependencies
  ################################################################################
  build-ios:
    name: Build iOS IPA
    runs-on: self-hosted
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Restore Flutter SDK from cache
      - name: Restore Flutter SDK
        uses: actions/cache/restore@v4
        with:
          path: ~/flutter
          key: flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}
          fail-on-cache-miss: true

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Restore Pub dependencies
      - name: Restore Pub dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          fail-on-cache-miss: true

      # Download generated code from setup job
      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      # Cache CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ios/Pods
            ios/Podfile.lock
          key: pods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      # Cache llama.cpp iOS libraries
      - name: Cache llama.cpp iOS libraries
        id: cache-llama-ios
        uses: actions/cache@v4
        with:
          path: ios/Frameworks/llama.xcframework
          key: llama-ios-${{ hashFiles('scripts/llama-version.txt') }}
          restore-keys: |
            llama-ios-

      # Build llama.cpp for iOS if not cached
      - name: Build llama.cpp for iOS
        if: steps.cache-llama-ios.outputs.cache-hit != 'true'
        run: |
          chmod +x scripts/build-llama-ios.sh
          bash scripts/build-llama-ios.sh

      # Verify llama.cpp framework exists
      - name: Verify llama.cpp framework
        run: |
          if [ ! -d "ios/Frameworks/llama.xcframework" ]; then
            echo "âŒ Error: llama.xcframework not found!"
            exit 1
          fi
          echo "âœ… llama.cpp framework found"
          ls -lh ios/Frameworks/

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      # Install CocoaPods dependencies
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      # Build iOS (no codesign for now)
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      # For signed builds, configure certificates and provisioning profiles
      # - name: Build iOS IPA
      #   run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      # Upload iOS build artifact
      - name: Upload iOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 30

  ################################################################################
  # CREATE RELEASE - Create GitHub release with artifacts
  ################################################################################
  create-release:
    name: Create Release
    needs: [build-android, build-ios]
    runs-on: self-hosted
    # Always create release on manual workflow dispatch
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download Android APK
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts

      # Download Android AAB
      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./artifacts

      # Download iOS build
      - name: Download iOS build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ./artifacts

      # Determine release tag (use run number for manual builds)
      - name: Determine release tag
        id: release-tag
        run: |
          # For manual workflow dispatch, use run number
          echo "tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT

      # Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: Release ${{ steps.release-tag.outputs.tag }}
          draft: false
          prerelease: false
          body: |
            ## ðŸš€ Release ${{ steps.release-tag.outputs.tag }}

            **Build Type:** Manual workflow dispatch
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ### ðŸ“¦ Artifacts
            - **Android APK**: `app-release.apk` - Ready for direct installation
            - **Android AAB**: `app-release.aab` - For Google Play Store
            - **iOS Build**: `Runner.app` - Requires signing for deployment

            ### ðŸ“ Changes
            See commit history for details: https://github.com/${{ github.repository }}/commits/${{ github.sha }}

            ### ðŸ”§ Built with
            - Flutter ${{ env.FLUTTER_VERSION }}
            - Java ${{ env.JAVA_VERSION }}
            - llama.cpp (version: see `scripts/llama-version.txt`)
            - LFM2.5-1.2B-Instruct model

            ### â±ï¸ Build Information
            - Workflow Run: #${{ github.run_number }}
            - Triggered by: @${{ github.actor }}
          files: |
            ./artifacts/app-release.apk
            ./artifacts/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Print summary
      - name: Print build summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK: $(ls -lh ./artifacts/app-release.apk | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- Android AAB: $(ls -lh ./artifacts/app-release.aab | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Release" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.release-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

