name: Build and Release

# Optimized CI/CD workflow with intelligent caching
#
# Trigger: Automatic on every push to main + manual workflow dispatch (via GitHub Actions UI)
#
# Architecture:
#   setup â†’ build-android â†˜
#                          â†’ create-release
#   setup â†’ build-ios     â†—
#
# Key features:
# - Runs on every push to main and can also be triggered manually
# - Separate setup job for dependencies (cached intelligently)
# - Parallel Android/iOS builds after setup
# - Caches: Flutter SDK, Pub, Gradle, CocoaPods, llama.cpp, generated code
# - Cache invalidation: automatic based on lock files and version files
# - Saves ~90% time on subsequent builds
# - Creates GitHub release with APK, AAB, and iOS build

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'
  ANDROID_NDK_VERSION: '25.1.8937393'
  LANG: en_US.UTF-8

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ################################################################################
  # SETUP - Install and cache all dependencies and tools
  ################################################################################
  setup:
    name: Setup Dependencies & Tools
    runs-on: self-hosted

    outputs:
      has-generated-code: ${{ steps.detect-generated.outputs.present }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Self-hosted runners are persistent: prefer using existing Flutter SDK on disk
      # and only update when FLUTTER_VERSION changes.
      - name: Ensure Flutter installed (reuse runner state)
        run: |
          if [ ! -d "$HOME/flutter/.git" ]; then
            git clone https://github.com/flutter/flutter.git -b stable $HOME/flutter
          fi
          cd $HOME/flutter
          git fetch --tags
          git checkout ${{ env.FLUTTER_VERSION }}

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # Run flutter doctor
      - name: Flutter Doctor
        run: flutter doctor -v

      # Get Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # Code generation (kept as a setup step so Android/iOS jobs don't duplicate work)
      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Detect generated code
        id: detect-generated
        run: |
          if find . -type f \( -name "*.g.dart" -o -name "*.freezed.dart" -o -name "*.config.dart" \) -print -quit | grep -q .; then
            echo "present=true" >> $GITHUB_OUTPUT
          else
            echo "present=false" >> $GITHUB_OUTPUT
          fi

      # Upload generated code as artifact for build jobs
      - name: Upload generated code
        if: steps.detect-generated.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: |
            **/*.g.dart
            **/*.freezed.dart
            **/*.config.dart
          if-no-files-found: warn
          retention-days: 1

      # Analyze code
      - name: Analyze code
        run: flutter analyze

      # Run tests
      - name: Run tests
        run: flutter test

  ################################################################################
  # BUILD ANDROID - Build APK/AAB with cached dependencies
  ################################################################################
  build-android:
    name: Build Android APK/AAB
    runs-on: self-hosted
    needs: setup

    # Self-hosted runners are persistent; isolate Gradle state per Java version to avoid
    # cache contamination when the machine default JDK changes (e.g. JDK 21 â†’ classfile 65).
    env:
      GRADLE_OPTS: -Dorg.gradle.daemon=false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Verify Flutter on runner
        run: |
          if [ ! -x "$HOME/flutter/bin/flutter" ]; then
            echo "âŒ Flutter not found at $HOME/flutter/bin/flutter"
            exit 1
          fi

      # Download generated code from setup job
      - name: Download generated code
        if: needs.setup.outputs.has-generated-code == 'true'
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      # Setup Java with Gradle caching
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Capture Java home (lock for later steps)
        run: |
          # Some Actions may modify JAVA_HOME; keep the JDK selected above for Flutter/Gradle.
          echo "JDK_HOME=$JAVA_HOME" >> "$GITHUB_ENV"

      - name: Show Java version
        run: java -version

      - name: Configure isolated Gradle cache
        run: |
          # Use a per-run Gradle user home to avoid reusing compiled script caches that may have
          # been produced by a different JDK on the persistent self-hosted runner.
          GRADLE_HOME="${RUNNER_TEMP}/gradle-${{ github.run_id }}-${{ github.run_attempt }}-jdk${{ env.JAVA_VERSION }}"
          echo "GRADLE_USER_HOME=$GRADLE_HOME" >> "$GITHUB_ENV"
          echo "ORG_GRADLE_JAVA_HOME=$JAVA_HOME" >> "$GITHUB_ENV"
          echo "Using GRADLE_USER_HOME=$GRADLE_HOME"
          echo "Using ORG_GRADLE_JAVA_HOME=$JAVA_HOME"
          mkdir -p "$GRADLE_HOME"
          # Fix: self-hosted runner may reuse compiled script caches created under a different JDK
          # (e.g. JDK 21 -> classfile major 65), which then fails under Java 17.
          rm -rf "$GRADLE_HOME/caches" "$GRADLE_HOME/daemon" || true

      - name: Verify Java used for Gradle
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          which java || true
          java -version

      - name: Verify Java before Flutter build
        run: |
          echo "JAVA_HOME(before)=$JAVA_HOME"
          echo "JDK_HOME=$JDK_HOME"
          echo "java(before)=$(which java || true)"
          java -version
          flutter doctor -v || true

      # Ensure Android SDK + sdkmanager are available (self-hosted runner might not export env vars)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Ensure Android NDK installed
        run: |
          sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
          yes | sdkmanager --licenses > /dev/null
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

      - name: Ensure CMake available (required by llama.cpp build scripts)
        run: |
          if command -v cmake >/dev/null 2>&1; then
            echo "âœ… CMake already available: $(cmake --version | head -n 1)"
            exit 0
          fi

          echo "CMake not found; installing via Android SDK..."
          sdkmanager --install "cmake;3.22.1"
          yes | sdkmanager --licenses > /dev/null

          CMAKE_BIN_DIR="$ANDROID_SDK_ROOT/cmake/3.22.1/bin"
          "$CMAKE_BIN_DIR/cmake" --version
          echo "$CMAKE_BIN_DIR" >> $GITHUB_PATH

      # Build (or reuse local runner cache) llama.cpp for Android
      - name: Ensure llama.cpp Android library
        run: |
          chmod +x scripts/build-llama-android.sh
          bash scripts/build-llama-android.sh

        # NOTE: Do not override ANDROID_NDK_HOME here.
        # On self-hosted runners it's usually configured as a machine-level env var,
        # and setting it via `${{ env.ANDROID_NDK_HOME }}` can unintentionally blank it.

      # Verify llama.cpp library exists
      - name: Verify llama.cpp library
        run: |
          if [ ! -f "android/app/src/main/jniLibs/arm64-v8a/libllama.so" ]; then
            echo "âŒ Error: libllama.so not found!"
            exit 1
          fi
          echo "âœ… llama.cpp library found"
          ls -lh android/app/src/main/jniLibs/*/libllama.so

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      # Build APK
      - name: Build APK
        run: |
          # Force Flutter/Gradle to use the JDK installed by actions/setup-java.
          export JAVA_HOME="$JDK_HOME"
          export PATH="$JAVA_HOME/bin:$PATH"
          echo "JAVA_HOME(used)=$JAVA_HOME"
          java -version
          flutter build apk --release --verbose

      # Build App Bundle
      - name: Build App Bundle
        run: |
          export JAVA_HOME="$JDK_HOME"
          export PATH="$JAVA_HOME/bin:$PATH"
          echo "JAVA_HOME(used)=$JAVA_HOME"
          java -version
          flutter build appbundle --release --verbose

      # Upload APK artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # Upload AAB artifact
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  ################################################################################
  # BUILD iOS - Build IPA with cached dependencies
  ################################################################################
  build-ios:
    name: Build iOS IPA
    runs-on: self-hosted
    needs: setup

    # ruby/setup-ruby expects a writable toolcache directory.

    # On self-hosted macOS runners the hosted default (/Users/runner/hostedtoolcache) may not exist.
    # NOTE: ruby/setup-ruby prebuilt Rubies are built for the default toolcache path on macOS
    # (/Users/runner/hostedtoolcache) and cannot be relocated.
    env:
      RUNNER_TOOL_CACHE: /Users/runner/hostedtoolcache
      AGENT_TOOLSDIRECTORY: /Users/runner/hostedtoolcache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Add Flutter to PATH
      - name: Add Flutter to PATH
        run: |
          echo "$HOME/flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Verify Flutter on runner
        run: |
          if [ ! -x "$HOME/flutter/bin/flutter" ]; then
            echo "âŒ Flutter not found at $HOME/flutter/bin/flutter"
            exit 1
          fi

      # Download generated code from setup job
      - name: Download generated code
        if: needs.setup.outputs.has-generated-code == 'true'
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: .

      - name: Ensure CMake available (required by llama.cpp build scripts)
        run: |
          if command -v cmake >/dev/null 2>&1; then
            echo "âœ… CMake already available: $(cmake --version | head -n 1)"
            exit 0
          fi

          if command -v brew >/dev/null 2>&1; then
            echo "CMake not found; installing via Homebrew..."
            HOMEBREW_NO_AUTO_UPDATE=1 brew install cmake
            cmake --version
            exit 0
          fi

          echo "âŒ Error: cmake is required but was not found, and Homebrew is unavailable on this runner."
          echo "Install CMake on the self-hosted runner, or add a workflow step to provide it."
          exit 1


      # Build (or reuse local runner cache) llama.cpp for iOS
      - name: Ensure llama.cpp for iOS
        run: |
          chmod +x scripts/build-llama-ios.sh
          bash scripts/build-llama-ios.sh

      # Verify llama.cpp framework exists
      - name: Verify llama.cpp framework
        run: |
          if [ ! -d "ios/Frameworks/llama.xcframework" ]; then
            echo "âŒ Error: llama.xcframework not found!"
            exit 1
          fi
          echo "âœ… llama.cpp framework found"
          ls -lh ios/Frameworks/

      # Get dependencies (should be fast due to cache)
      - name: Get dependencies
        run: flutter pub get

      - name: Detect CocoaPods
        id: detect_pod
        run: |
          if command -v pod >/dev/null 2>&1; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure Ruby toolcache dir exists (self-hosted)
        if: steps.detect_pod.outputs.present != 'true'
        run: |
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          echo "AGENT_TOOLSDIRECTORY=$AGENT_TOOLSDIRECTORY"
          TOOLCACHE="$RUNNER_TOOL_CACHE"

          if [ -d "$TOOLCACHE" ] && [ -w "$TOOLCACHE" ]; then
            echo "âœ… Toolcache is writable: $TOOLCACHE"
            exit 0
          fi

          echo "âš ï¸  Toolcache is missing or not writable: $TOOLCACHE"
          echo "Attempting to create it (requires sudo on most self-hosted runners)..."

          if command -v sudo >/dev/null 2>&1; then
            sudo mkdir -p "$TOOLCACHE"
            sudo chown -R "$(id -un)":"$(id -gn)" /Users/runner
          else
            echo "âŒ sudo is not available. Please create $TOOLCACHE and make it writable for the runner user."
            exit 1
          fi

          if [ ! -w "$TOOLCACHE" ]; then
            echo "âŒ Toolcache is still not writable after attempting to fix permissions: $TOOLCACHE"
            exit 1
          fi
          echo "âœ… Toolcache prepared: $TOOLCACHE"

      - name: Setup Ruby (for CocoaPods)
        if: steps.detect_pod.outputs.present != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      # Install CocoaPods dependencies
      - name: Install CocoaPods dependencies
        run: |
          if ! command -v pod >/dev/null 2>&1; then
            echo "âš ï¸  CocoaPods (pod) not found. Installing to user gem dir..."
            if ! command -v gem >/dev/null 2>&1; then
              echo "âŒ RubyGems (gem) not found on runner; cannot install CocoaPods"
              exit 1
            fi
            # Use a modern Ruby (via ruby/setup-ruby) to avoid ffi/CocoaPods install failures on
            # older system Rubies on persistent self-hosted runners.
            gem install --user-install cocoapods -N
            POD_BIN_DIR="$(ruby -e 'print Gem.user_dir')/bin"
            echo "$POD_BIN_DIR" >> "$GITHUB_PATH"
            export PATH="$POD_BIN_DIR:$PATH"
          fi
          pod --version
          cd ios
          pod install

      # Build iOS (no codesign for now)
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      # For signed builds, configure certificates and provisioning profiles
      # - name: Build iOS IPA
      #   run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      # Upload iOS build artifact
      - name: Upload iOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 30

  ################################################################################
  # CREATE RELEASE - Create GitHub release with artifacts
  ################################################################################
  create-release:
    name: Create Release
    needs: [build-android, build-ios]
    runs-on: self-hosted
    # Always create release on manual workflow dispatch
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download Android APK
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts

      # Download Android AAB
      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ./artifacts

      # Download iOS build
      - name: Download iOS build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ./artifacts

      # Determine release tag (use run number for manual builds)
      - name: Determine release tag
        id: release-tag
        run: |
          # For manual workflow dispatch, use run number
          echo "tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT

      # Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          name: Release ${{ steps.release-tag.outputs.tag }}
          draft: false
          prerelease: false
          body: |
            ## ðŸš€ Release ${{ steps.release-tag.outputs.tag }}

            **Build Type:** Manual workflow dispatch
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ### ðŸ“¦ Artifacts
            - **Android APK**: `app-release.apk` - Ready for direct installation
            - **Android AAB**: `app-release.aab` - For Google Play Store
            - **iOS Build**: `Runner.app` - Requires signing for deployment

            ### ðŸ“ Changes
            See commit history for details: https://github.com/${{ github.repository }}/commits/${{ github.sha }}

            ### ðŸ”§ Built with
            - Flutter ${{ env.FLUTTER_VERSION }}
            - Java ${{ env.JAVA_VERSION }}
            - llama.cpp (version: see `scripts/llama-version.txt`)
            - LFM2.5-1.2B-Instruct model

            ### â±ï¸ Build Information
            - Workflow Run: #${{ github.run_number }}
            - Triggered by: @${{ github.actor }}
          files: |
            ./artifacts/app-release.apk
            ./artifacts/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Print summary
      - name: Print build summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK: $(ls -lh ./artifacts/app-release.apk | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- Android AAB: $(ls -lh ./artifacts/app-release.aab | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Release" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.release-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

